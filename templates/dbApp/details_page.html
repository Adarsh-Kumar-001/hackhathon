{% extends "dbApp/base.html" %}
{% load static %}

{% block title %}Product Details{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row">
        <div class="col-md-6">
            <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid product-detail-img">
        </div>
        <div class="col-md-6">
            <h1>{{ product.name }}</h1>
            <p class="text-muted">{{ product.category }}</p>
            <h2 class="price">â‚¹{{ product.price|floatformat:2 }}</h2>
            <p>{{ product.description|linebreaksbr }}</p>

            <form id="add-to-cart-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="product_id" value="{{ product.id }}">
                <div class="d-flex align-items-center mb-3">
                    <label for="quantity" class="me-3">Quantity:</label>
                    <input type="number" name="quantity" id="quantity" value="1" min="1" class="form-control" style="width: 80px;">
                </div>
                <button type="submit" class="btn btn-primary add-to-cart-btn">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </form>
        </div>
    </div>
</div>
{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const addToCartForm = document.getElementById('add-to-cart-form');
        const cartCountElement = document.querySelector('.cart-count');

        if (addToCartForm) {
            addToCartForm.addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(addToCartForm);
                const data = {
                    product_id: formData.get('product_id'),
                    quantity: parseInt(formData.get('quantity')) || 1
                };
                
                // Assuming you have a URL for your add_to_cart view
                fetch("{% url 'add_to_cart' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify(data),
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(result.message);
                        if (cartCountElement) {
                            // Update the count with the number returned from the server
                            cartCountElement.textContent = result.item_count;
                        }
                    } else {
                        alert(result.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again.');
                });
            });
        }
    });
</script>
{% endblock scripts %}